// Generated by CoffeeScript 1.6.3
(function() {
  var Game, initEngineAndGame, keyMapping, root;

  keyMapping = {
    40: 'break',
    38: 'thurst',
    37: 'rotateLeft',
    39: 'rotateRight'
  };

  Game = (function() {
    function Game() {
      var action, code;
      this.actions = {};
      for (code in keyMapping) {
        action = keyMapping[code];
        this.actions[action] = false;
      }
    }

    Game.prototype.restart = function(geometry) {
      this.geometry = this.geometries[geometry];
      this.spaceShip = new cofgl.SpaceShip();
      return this.world = new cofgl.World(this.spaceShip);
    };

    Game.prototype.initGame = function() {
      this.processor = new cofgl.Processor(cofgl.resmgr.resources['shaders/nothing']);
      this.geometries = {
        euclidean: {
          shader: cofgl.resmgr.resources['shaders/euclidean'],
          step: cofgl.euclidStep
        },
        hyperbolic: {
          shader: cofgl.resmgr.resources['shaders/hyperbolic'],
          step: cofgl.poincareStep
        },
        elliptic: {
          shader: cofgl.resmgr.resources['shaders/elliptic'],
          step: cofgl.kleinStep
        }
      };
      this.geometry = this.geometries.euclidean;
      this.spaceShip = new cofgl.SpaceShip();
      return this.world = new cofgl.World(this.spaceShip);
    };

    Game.prototype.initEventHandlers = function() {
      var _this = this;
      return $(window).bind('keydown', function(event) {
        return _this.onKeyDown(event);
      }).bind('keyup', function(event) {
        return _this.onKeyUp(event);
      });
    };

    Game.prototype.onKeyDown = function(event) {
      var action;
      action = keyMapping[event.which];
      if (action != null) {
        this.actions[action] = true;
        return false;
      }
    };

    Game.prototype.onKeyUp = function(event) {
      var action;
      action = keyMapping[event.which];
      if (action != null) {
        this.actions[action] = false;
        return false;
      }
    };

    Game.prototype.run = function() {
      var _this = this;
      return cofgl.resmgr.wait(function() {
        _this.initGame();
        _this.initEventHandlers();
        return _this.mainloop();
      });
    };

    Game.prototype.mainloop = function() {
      var _this = this;
      return cofgl.engine.mainloop(function(dt) {
        _this.updateGame(dt);
        return _this.render();
      });
    };

    Game.prototype.updateGame = function(dt) {
      if (this.actions.rotateRight) {
        this.spaceShip.rotateRight();
      }
      if (this.actions.rotateLeft) {
        this.spaceShip.rotateLeft();
      }
      if (this.actions.thurst) {
        this.spaceShip.thurst();
      }
      if (this.actions["break"]) {
        this.spaceShip["break"]();
      }
      this.spaceShip.update(dt);
      return this.world.update(dt);
    };

    Game.prototype.render = function() {
      cofgl.clear();
      this.processor.push();
      this.world.draw();
      return this.processor.pop();
    };

    return Game;

  })();

  initEngineAndGame = function(selector, debug) {
    var canvas;
    canvas = $(selector)[0];
    cofgl.debugPanel = new cofgl.DebugPanel();
    cofgl.engine = new cofgl.Engine(canvas, debug);
    cofgl.resmgr = cofgl.makeDefaultResourceManager();
    cofgl.game = new Game;
    cofgl.game.run();
    return $("input[name='geometry']").change(function() {
      return cofgl.game.restart(this.value);
    });
  };

  $(document).ready(function() {
    var debug;
    debug = cofgl.getRuntimeParameter('debug') === '1';
    return initEngineAndGame('#viewport', debug);
  });

  root = self.cofgl != null ? self.cofgl : self.cofgl = {};

  root.game = null;

  root.geometries = null;

  root.debugPanel = null;

  root.resmgr = null;

  root.engine = null;

}).call(this);
